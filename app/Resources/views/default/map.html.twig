{% extends 'base.html.twig' %}

{% block body %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div id="map" style="height: 100vh;"></div>
            </div>
        </div>
    </div>

	<script>
		var map;
		var coordinates = {{ points|json_encode|raw }};
		var heatmap;
		function initMap() {
	        map = new google.maps.Map(document.getElementById('map'), {
		    	center: {lat: -27.6102281, lng: -48.6250075},
				zoom: 11
			});

	        google.maps.event.addListener(map, 'idle', function(){
	        	if (heatmap){
	        		heatmap.setMap(null);	
	        	}
	        	
			 	heatmap = new google.maps.visualization.HeatmapLayer({
					data: getPoints(),
					radius: 20,
					map: map
		        });
            });
		}

		function getPoints() {
			var googleLatLong = [];
			var googleLatLongPrepare = [];
			$.each(coordinates, function(index, value){
				var googleLatLngPoint = new google.maps.LatLng(value.latitude, value.longitude);

				if (map.getBounds().contains(googleLatLngPoint)){
					if (value.weight === undefined){
						value.weight = 1;
					}
					googleLatLongPrepare.push({location: googleLatLngPoint, weight: value.weight});
				}

				// Caso não seja dinâmico, descomentar esta linha e comentar o uso do googleLatLngPrepare
				// googleLatLong.push({location: googleLatLngPoint, weight: value.weight});	
			});

			googleLatLongPrepare.sort(function(a,b){
				if (a.weight === b.weight) {
					return 0;
				}
				return (parseInt(a.weight) > parseInt(b.weight)) ? -1 : 1;
			});

			var higher = googleLatLongPrepare[0].weight;

			$.each(googleLatLongPrepare, function(index, value){
				value.weight = value.weight / higher;
				if (value.weight < 0.5){
					value.weight = 0.5;
				}
				googleLatLong.push(value);
			});
			
			return googleLatLong;	
		}
	</script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNSeZrDCKuKexdxUnjM6RB5nbENawL0G0&callback=initMap&libraries=visualization" async defer></script>
{% endblock %}
